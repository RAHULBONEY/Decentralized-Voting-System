<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blockchain Voting App</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

      body {
        font-family: "Inter", sans-serif;
        background-color: #1a202c;
        color: #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }

      .container {
        background-color: #2d3748;
        padding: 2rem;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        width: 100%;
        max-width: 48rem;
        border: 1px solid #4a5568;
      }

      .main-heading {
        font-size: 1.875rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 1.5rem;
        color: #818cf8;
      }

      .status-message {
        background-color: #312e81;
        color: #a5b4fc;
        padding: 0.75rem;
        border-radius: 0.5rem;
        text-align: center;
        margin-bottom: 1rem;
      }

      .status-message.success {
        background-color: #064e3b;
        color: #6ee7b7;
      }

      .status-message.error {
        background-color: #7f1d1d;
        color: #fca5a5;
      }

      .app-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      @media (min-width: 768px) {
        .app-container {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .section {
        background-color: #4a5568;
        padding: 1.5rem;
        border-radius: 0.75rem;
        border: 1px solid #6b7280;
      }

      .section-heading {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
        text-align: center;
        color: #cbd5e0;
      }

      .input-field {
        width: 100%;
        padding: 0.75rem;
        border-radius: 0.5rem;
        background-color: #4a5568;
        border: 1px solid #718096;
        color: #e2e8f0;
        placeholder-color: #a0aec0;
        outline: none;
        transition: ring-width 0.2s;
      }

      .input-field:focus {
        ring: 2px;
        ring-color: #6366f1;
      }

      .btn {
        width: 100%;
        font-weight: 700;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        color: white;
        transition: background-color 0.2s;
        outline: none;
        ring: 2px;
        ring-offset: 2px;
      }

      .btn-indigo {
        background-color: #4f46e5;
      }

      .btn-indigo:hover {
        background-color: #6366f1;
      }

      .btn-green {
        background-color: #10b981;
      }

      .btn-green:hover {
        background-color: #059669;
      }

      .btn-gray {
        background-color: #4a5568;
        color: #cbd5e0;
      }

      .btn-gray:hover {
        background-color: #6366f1;
      }

      .results-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .result-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #4a5568;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }

      .candidate-name {
        font-size: 1.25rem;
        font-weight: 500;
        color: #cbd5e0;
      }

      .vote-count {
        font-size: 1.25rem;
        font-weight: 700;
        color: #818cf8;
      }
    </style>
  </head>
  <body
    class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen"
  >
    <div class="container">
      <h1 class="main-heading">Decentralized Voting DApp</h1>

      <div id="status-message" class="status-message">
        Connect your MetaMask wallet to begin.
      </div>

      <div id="app-container" class="app-container hidden">
        <!-- Registration Section -->
        <div class="section">
          <h2 class="section-heading">Register as a Voter</h2>
          <input
            type="text"
            id="voter-address-input"
            class="input-field"
            placeholder="Enter Voter Address (Admin Only)"
          />
          <button id="register-voter-btn" class="btn btn-indigo mt-4">
            Register Voter
          </button>
        </div>

        <!-- Voting Section -->
        <div class="section">
          <h2 class="section-heading">Cast Your Vote</h2>
          <select id="candidate-select" class="input-field">
            <option value="">Select a Candidate</option>
            <!-- Candidates will be populated here -->
          </select>
          <button id="vote-btn" class="btn btn-green mt-4">Vote</button>
        </div>

        <!-- Election Results Section -->
        <div class="section mt-6">
          <h2 class="section-heading">Election Results</h2>
          <div id="results-list" class="results-list">
            <!-- Results will be populated here -->
          </div>
          <button id="refresh-results-btn" class="btn btn-gray mt-4">
            Refresh Results
          </button>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const statusMessage = document.getElementById("status-message");
        const appContainer = document.getElementById("app-container");
        const candidateSelect = document.getElementById("candidate-select");
        const voteBtn = document.getElementById("vote-btn");
        const registerVoterBtn = document.getElementById("register-voter-btn");
        const voterAddressInput = document.getElementById(
          "voter-address-input"
        );
        const resultsList = document.getElementById("results-list");
        const refreshResultsBtn = document.getElementById(
          "refresh-results-btn"
        );

        let provider;
        let signer;
        let contract;
        let contractOwner;

        //  address of  deployed smart contract from Remix
        const contractAddress = "0x29b78701f2738f33d91b2b83c18eb608dfc5fe9e";
        const contractABI = [
          "constructor()",
          "function addCandidate(string memory _name) private",
          "function addCandidate(string memory _name) private onlyOwner",
          "function registerVoter(address _voter) public onlyOwner",
          "function vote(uint _candidateId) public",
          "function getCandidate(uint _candidateId) public view returns (string memory, uint)",
          "function getCandidatesCount() public view returns (uint)",
          "function owner() public view returns (address)",
          "function candidates(uint) public view returns (string memory name, uint voteCount)",
          "function voters(address) public view returns (bool)",
        ];

        const init = async () => {
          if (typeof window.ethereum !== "undefined") {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            try {
              await provider.send("eth_requestAccounts", []);
              signer = provider.getSigner();
              // correct checksum format.
              //  try-catch block to handle cases ifs the address is not a valid hexadecimal string.
              let contractInstanceAddress;
              try {
                contractInstanceAddress =
                  ethers.utils.getAddress(contractAddress);
                contract = new ethers.Contract(
                  contractInstanceAddress,
                  contractABI,
                  signer
                );
              } catch (addressError) {
                console.error(
                  "Invalid contract address:",
                  addressError.message
                );
                statusMessage.textContent =
                  "Error: Invalid contract address. Please check the code.";
                statusMessage.className = "status-message error";
                return;
              }

              const accounts = await provider.listAccounts();
              const userAddress = accounts[0];
              const network = await provider.getNetwork();

              statusMessage.textContent = `Connected to network: ${
                network.name
              }, Address: ${userAddress.substring(
                0,
                6
              )}...${userAddress.substring(38)}`;
              statusMessage.className = "status-message success";
              appContainer.classList.remove("hidden");

              contractOwner = await contract.owner();

              await populateCandidates();
              await updateResults();

              // Event listeners
              voteBtn.addEventListener("click", handleVote);
              registerVoterBtn.addEventListener("click", handleRegisterVoter);
              refreshResultsBtn.addEventListener("click", updateResults);
            } catch (error) {
              console.error(
                "User denied account access or another error occurred:",
                error
              );
              statusMessage.textContent =
                "Please connect to your wallet to continue.";
            }
          } else {
            statusMessage.textContent =
              "MetaMask is not installed. Please install it to use this DApp.";
            statusMessage.className = "status-message error";
          }
        };

        const populateCandidates = async () => {
          try {
            const count = await contract.getCandidatesCount();
            candidateSelect.innerHTML =
              '<option value="">Select a Candidate</option>';
            for (let i = 0; i < count; i++) {
              const candidate = await contract.candidates(i);
              const option = document.createElement("option");
              option.value = i;
              option.textContent = candidate.name;
              candidateSelect.appendChild(option);
            }
          } catch (error) {
            console.error("Error fetching candidates:", error);
          }
        };

        const handleVote = async () => {
          const selectedCandidateId = candidateSelect.value;
          if (!selectedCandidateId) {
            alert("Please select a candidate to vote for.");
            return;
          }
          try {
            statusMessage.textContent =
              "Casting your vote... Please confirm in your wallet.";
            statusMessage.className = "status-message info";

            const tx = await contract.vote(selectedCandidateId);
            await tx.wait();

            statusMessage.textContent = "Vote cast successfully!";
            statusMessage.className = "status-message success";

            await updateResults();
          } catch (error) {
            console.error("Error voting:", error);
            statusMessage.textContent = `Error voting: ${error.message}`;
            statusMessage.className = "status-message error";
          }
        };

        const handleRegisterVoter = async () => {
          const voterAddress = voterAddressInput.value;
          if (!voterAddress || !ethers.utils.isAddress(voterAddress)) {
            alert("Please enter a valid Ethereum address.");
            return;
          }

          const accounts = await provider.listAccounts();
          const userAddress = accounts[0];
          if (userAddress.toLowerCase() !== contractOwner.toLowerCase()) {
            alert("Only the contract owner can register new voters.");
            return;
          }

          try {
            statusMessage.textContent =
              "Registering new voter... Please confirm in your wallet.";
            statusMessage.className = "status-message info";

            const tx = await contract.registerVoter(voterAddress);
            await tx.wait();

            statusMessage.textContent = `Voter ${voterAddress.substring(
              0,
              6
            )}...${voterAddress.substring(38)} registered successfully!`;
            statusMessage.className = "status-message success";
          } catch (error) {
            console.error("Error registering voter:", error);
            statusMessage.textContent = `Error registering voter: ${error.message}`;
            statusMessage.className = "status-message error";
          }
        };

        const updateResults = async () => {
          try {
            const count = await contract.getCandidatesCount();
            resultsList.innerHTML = "";
            for (let i = 0; i < count; i++) {
              const candidate = await contract.candidates(i);
              const resultItem = document.createElement("div");
              resultItem.className = "result-item";
              resultItem.innerHTML = `
                            <span class="candidate-name">${
                              candidate.name
                            }</span>
                            <span class="vote-count">${candidate.voteCount.toString()} Votes</span>
                        `;
              resultsList.appendChild(resultItem);
            }
          } catch (error) {
            console.error("Error fetching results:", error);
            resultsList.innerHTML = `<p class="text-center text-red-400">Failed to load results. Please check your connection.</p>`;
          }
        };

        function copySolidityCode() {
          const codeBlock = document.getElementById("solidity-code");
          const range = document.createRange();
          range.selectNode(codeBlock);
          window.getSelection().removeAllRanges();
          window.getSelection().addRange(range);
          try {
            document.execCommand("copy");
            alert("Solidity code copied to clipboard!");
          } catch (err) {
            console.error("Failed to copy text:", err);
            alert("Failed to copy code. Please select and copy manually.");
          }
          window.getSelection().removeAllRanges();
        }

        init();
      });
    </script>
  </body>
</html>
